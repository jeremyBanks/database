# x/database/sql for Deno, Version 0.1

**Date:** February ?, 2021

**Status:** design and implementation are still incomplete, to be reviewed at
[#3](https://github.com/jeremyBanks/database/pull/3).

## Background

Deno currently has several great driver libraries for different database
engines. However, each one provides a slightly different interface, with a
slightly different set of functionality, creating friction for users who want to
write code that works across database engines. This is similar to the position
that Go was in that led to the creation of their database/sql library. Deno
isn't exactly the same as Go, but they have a lot in common. With some changes,
we can take Go's API design and their 
["Goals of the sql and sql/driver
packages"](https://golang.org/src/database/sql/doc.txt) (below) as a starting point for
our own library.

> - Provide a generic database API for a variety of SQL or SQL-like databases.
  > There currently exist Go libraries for SQLite, MySQL, and Postgres, but all
  > with a very different feel, and often a non-Go-like feel.
> - Feel like Go.
> - Care mostly about the common cases. Common SQL should be portable. SQL edge
  > cases or db-specific extensions can be detected and conditionally used by
  > the application. It is a non-goal to care about every particular db's
  > extension or quirk.
> - Separate out the basic implementation of a database driver (implementing the
  > `sql/driver` interfaces) vs the implementation of all the user-level types
  > and convenience methods. In a nutshell:<br> User Code &rarr; `sql` package
  > (concrete types) &rarr; `sql/driver` (interfaces)<br> Database Driver &rarr;
  > `sql` (to register) + `sql/driver` (implement interfaces)
> - Make type casting/conversions consistent between all drivers. To achieve
  > this, most of the conversions are done in the `sql` package, not in each
  > driver. The drivers then only have to deal with a smaller set of types.
> - Be flexible with type conversions, but be paranoid about silent truncation
  > or other loss of precision.
> - Handle concurrency well. Users shouldn't need to care about the database's
  > per-connection thread safety issues (or lack thereof), and shouldn't have to
  > maintain their own free pools of connections. The `sql` package should deal
  > with that bookkeeping as needed. Given an `*sql.DB`, it should be possible
  > to share that instance between multiple goroutines, without any extra
  > synchronization.
> - Push complexity, where necessary, down into the `sql`+`driver` packages,
  > rather than exposing it to users. Said otherwise, the `sql` package should
  > expose an ideal database that's not finnicky about how it's accessed, even
  > if that's not true.
> - Provide optional interfaces in `sql/driver` for drivers to implement for
  > special cases or fastpaths. But the only party that knows about those is the
  > sql package. To user code, some stuff just might start working or start
  > working slightly faster.

## Goals

For this initial v0.1 release, we would like to provide a set of core
capabilities that are enough to be useful, though they may not be as
comprehensive, flexible, or convenient ("sugary") as we would eventually like.

Prior to v1.0, we do not make any guarantees about API stability
([as per semver](https://semver.org/spec/v2.0.0.html#spec-item-4)), but we
should still be thoughtful and try to avoid unnecessary breakage.

## Database Consumer Interface (`x/database/sql/sql.ts`)

This is the primary interface for most users.

- `sql.open(path, driver): sql.Database`
  - Creates a database handle/connector with the given driver and path. May
    validate the arguments (path), but
- `sql.Database`
  - `.connect(): Promise<sql.Connection>`
    - Returns a open connection to the database. In the future this should be a
      reused connection from a connection pool, but for this release it will
      always be a new connection.
- `sql.Connection`
  - `.startTransaction(): Promise<sql.Transaction>`
  - `.dispose(): void`
    - Must be called to free the resources
- `sql.Transaction`
  - `.prepareStatement(): Promise<sql.PreparedStatement>`
  - `.commit(): void`
  - `.rollback(): void`
- `sql.PreparedStatement`
  - `.exec(args?): Promise<void>`
  - `.query(args?): AsyncGenerator<sql.Row>`
  - `.queryRow(args?): Promise<sql.Row>`
- `sql.Row` will only be an `Iterable<…>` over the columns for now.

## Database Driver Interface (`x/database/sql/driver.ts`)

Primarily asynchronous, but most methods have `Sync` alternatives that non-async
drivers may implement instead.

- driver.Driver
  - .open[Sync](path: string): driver.Connector
- driver.Connector

### Driver `Meta` Type Information

A driver SHOULD declare an associated `Meta` type using the `driver.Meta<{...}>`
type function. This is currently used only to specify the type of values used by
the driver for bound and result column values. The `Meta` type SHOULD be
provided as the (optional) first type argument to every interface that is
implemented from `driver.sql`.

```ts
type Meta = driver.Meta<{
  Value: bigint | number | null
}>;

export class Connection extends driver.Connection<Meta> { … }
```

If a driver does not define and use its own `Meta` type, a default `Meta` will
be used which expects only the the JSON primitive types: `null`, `boolean`,
`number` and `string`.

## Cancellation, Timeouts, Context

Cancellation and timeouts are not supported in this release. Something like Go's
[Context](https://blog.golang.org/context), or potentially using
[AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController),
will be considered for a future release.

## Included Driver Implementations (`x/database/x/…`)

Once this library's driver interface is complete and stable, it is expected that
driver libraries would implement the supporting interface themselves, without
anything required in this repository. However, that can't happen while this is
still under unstable development, so for now we will include our own driver
interface implementations for a couple different database driver libraries:

- `…/sqlite.ts` wrapping [`/x/sqlite/`](https://deno.land/x/sqlite), an
  [MIT-Licensed](https://github.com/dyedgreen/deno-sqlite/blob/master/LICENSE)
  synchronous in-process WASM SQLite library.
- `…/postgres.ts` wrapping [`/x/postgres/`](https://deno.land/x/postgres), an
  [MIT-Licensed](https://github.com/denodrivers/postgres#license) asynchronous
  PostgreSQL client library.
